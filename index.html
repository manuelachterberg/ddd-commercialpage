<!doctype html>
<html lang="de" data-mode="regular">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Werbespot Generator</title>
  <style>
    /* --- Reset & base --- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; color: var(--fg); background: #0b0f14; overflow: hidden; }

    /* --- Theme tokens --- */
    :root { --radius: 18px; --shadow: 0 12px 34px rgba(0,0,0,.35); }
    html[data-mode="regular"] { --fg: #0b1020; --muted: #475569; --accent: #2563eb; --accent-2: #22d3ee; --glass: rgba(255, 255, 255, 0.2); --border: rgba(15, 23, 42, .15); }
    html[data-mode="ddd"]     { --fg: #e7d7b6; --muted: #b9a57d; --accent: #d97706; --accent-2: #f59e0b; --glass: rgba(60, 48, 30, 0.52); --border: rgba(255, 230, 180, .22); background-color: #2b2419; }
    /* NEW: Maker-Theme */
    html[data-mode="maker"]   { 
      --fg: #0e1022; 
      --muted: #6b7280; 
      --accent: #6366f1;          /* indigo */
      --accent-2: #22d3ee;        /* cyan */
      --glass: rgba(180, 200, 255, 0.20); 
      --border: rgba(99,102,241,.35); 
      background-color: #0a0f1a; 
    }

    /* Maker neon UI */
    html[data-mode="maker"] h1{
      color:#c7d2fe;
      text-shadow:
        0 0 6px rgba(99,102,241,.85),
        0 0 14px rgba(34,211,238,.55),
        0 0 28px rgba(99,102,241,.35);
      letter-spacing:.6px;
    }
    html[data-mode="maker"] .panel{
      box-shadow:
        0 10px 28px rgba(0,0,0,.35),
        0 0 22px rgba(99,102,241,.25),
        inset 0 0 0 1px rgba(99,102,241,.18);
    }
    html[data-mode="maker"] .tag{
      border-color: rgba(99,102,241,.45);
      color:#c7d2fe;
      text-shadow: 0 0 8px rgba(99,102,241,.45);
    }
    html[data-mode="maker"] button.primary{
      box-shadow:
        0 0 14px rgba(99,102,241,.55),
        0 6px 20px rgba(0,0,0,.25);
      filter: saturate(1.15) brightness(1.05);
    }
    html[data-mode="maker"] button.primary:hover{
      box-shadow:
        0 0 18px rgba(34,211,238,.75),
        0 10px 26px rgba(0,0,0,.3);
      filter: saturate(1.22) brightness(1.08);
    }
    /* Fancy mode radio chips */
    .mode-select input[type="radio"]{
      position:absolute;
      opacity:0;
      pointer-events:none;
      width:0;height:0;
    }
    .mode-select label{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }
    .mode-select label span{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(6px) saturate(1.1);
      -webkit-backdrop-filter: blur(6px) saturate(1.1);
      color: var(--fg);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        0 6px 16px rgba(0,0,0,.18);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease, background .2s ease;
    }
    .mode-select label:hover span{
      transform: translateY(-1px);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.08),
        0 10px 24px rgba(0,0,0,.22);
    }
    /* Regular chip */
    .mode-select input[value="regular"] + span{
      background: linear-gradient(135deg, rgba(37,99,235,.15), rgba(34,211,238,.12));
      border-color: rgba(37,99,235,.35);
    }
    .mode-select input[value="regular"]:checked + span{
      background: linear-gradient(135deg, #2563eb, #22d3ee);
      color:#fff;
      text-shadow: 0 0 6px rgba(34,211,238,.5);
      box-shadow:
        0 0 18px rgba(34,211,238,.45),
        0 8px 22px rgba(0,0,0,.28);
    }
    /* MAKER chip */
    .mode-select input[value="maker"] + span{
      background: linear-gradient(135deg, rgba(99,102,241,.16), rgba(34,211,238,.12));
      border-color: rgba(99,102,241,.38);
    }
    .mode-select input[value="maker"]:checked + span{
      background: linear-gradient(135deg, #6366f1, #22d3ee);
      color:#fff;
      text-shadow: 0 0 8px rgba(99,102,241,.55);
      box-shadow:
        0 0 20px rgba(99,102,241,.45),
        0 8px 22px rgba(0,0,0,.28);
    }
    /* DDD chip */
    .mode-select input[value="ddd"] + span{
      background: linear-gradient(135deg, rgba(217,119,6,.16), rgba(245,158,11,.12));
      border-color: rgba(217,119,6,.40);
    }
    .mode-select input[value="ddd"]:checked + span{
      background: linear-gradient(135deg, #d97706, #f59e0b);
      color:#2b2419;
      text-shadow: 0 0 6px rgba(245,158,11,.45);
      box-shadow:
        0 0 18px rgba(245,158,11,.35),
        0 8px 22px rgba(0,0,0,.28);
    }

    /* --- Layout --- */
    #app { position: fixed; inset: 0; display: grid; place-items: center; padding: clamp(16px, 2vw, 32px); }
    #gl { position: fixed; inset: 0; width: 100%; height: 100%; display: block; }

    .panel { position: relative; width: min(900px, 92vw); backdrop-filter: blur(20px) saturate(1.2); -webkit-backdrop-filter: blur(20px) saturate(1.2);
      background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .panel::after { content: ""; position: absolute; inset: 0; pointer-events: none; border-radius: inherit; mix-blend-mode: overlay; }

    .content { display: grid; gap: 18px; padding: clamp(20px, 4vw, 36px); }
    .row { display: flex; gap: 14px; align-items: center; justify-content: space-between; flex-wrap: wrap; }

    h1 { margin: 0; font-size: clamp(22px, 3.2vw, 34px); letter-spacing: 0.2px; }
    .tag { font-size: 12px; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); opacity: .9; }

    textarea { width: 100%; min-height: 140px; resize: vertical; padding: 14px 16px; border-radius: calc(var(--radius) - 6px); border: 1px solid var(--border); outline: none; background: rgba(255,255,255,.88); color: #0b1020; font-size: 16px; line-height: 1.5; box-shadow: inset 0 2px 8px rgba(0,0,0,.06); }
    html[data-mode="ddd"] textarea { background: rgba(40,30,15,.88); color: #f5f5dc; }

    .actions { display: flex; gap: 10px; align-items: center; justify-content: flex-end; }

    button.primary { appearance: none; border: none; padding: 12px 16px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; font-weight: 700; letter-spacing: .2px; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,.25); transition: transform .05s ease, box-shadow .2s ease, filter .2s ease; }
    button.primary:hover { filter: brightness(1.05); box-shadow: 0 10px 26px rgba(0,0,0,.3); }
    button.primary:active { transform: translateY(1px) scale(.997); }
    button.primary[disabled] { filter: grayscale(1); cursor: progress; opacity: .7; }

    button.secondary { appearance:none; border:1px solid var(--border); background:transparent; color: var(--fg); padding: 12px 14px; border-radius: 12px; cursor: pointer; }
    button.secondary:hover { background: rgba(255,255,255,0.08); }

    .footer { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted); }

    html[data-mode="ddd"] .panel { box-shadow: 0 18px 40px rgba(165, 90, 0,.25), inset 0 0 0 1px rgba(255,255,255,.08); }
    html[data-mode="ddd"] .panel::after { background: repeating-linear-gradient(180deg, rgba(255,230,180,.06) 0 2px, rgba(0,0,0,0) 2px 4px); }

    #status { font-size: 14px; min-height: 1.5em; color: var(--muted); }
    #result { margin-top: 10px; }
    audio { width: 100%; margin-top: 8px; }
    .visually-hidden{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px, 1px, 1px, 1px); white-space:nowrap; }

    /* Loading spinner */
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader { display:inline-flex; align-items:center; gap:10px; color: var(--muted); }
    .loader .ring { width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,.28); border-top-color: var(--accent); animation: spin .8s linear infinite; }
    .hidden { display: none !important; }
    .download-link { display:inline-block; margin-top:8px; font-size:14px; color: var(--accent); text-decoration: underline; cursor: pointer; }

    .qrbox { display:inline-flex; align-items:center; gap:10px; margin-top:10px; padding:10px; border:1px solid var(--border); border-radius:12px; background: rgba(255,255,255,0.08); }
    .qrbox .label { font-size:12px; color:var(--muted); }
    .qrbox svg, .qrbox canvas { width:140px; height:140px; display:block; }
    .qrbox .qrcanvas { width:140px; height:140px; display:block; background:#fff; border:1px solid var(--border); border-radius:8px; image-rendering: pixelated; }
    .qrbox img { 
      width:140px; height:140px; display:block; 
      background:#fff; border:1px solid var(--border); 
      border-radius:8px; image-rendering: pixelated; 
    }
    .qrbox { position: relative; z-index: 1; }

    /* === CRT effect for DDD mode === */
    @keyframes crtFlicker { 0%, 100% { opacity: 0.98; } 50% { opacity: 1; } }
    @keyframes crtJitter { 0%, 100% { transform: translateZ(0); } 50% { transform: translateY(0.2px); } }
    @keyframes scanShift { 0% { background-position: 0 0; } 100% { background-position: 0 2px; } }

    html[data-mode="ddd"] .crt {
      position: relative;
      filter:
        contrast(1.08)
        saturate(1.22)
        drop-shadow(1px 0 0 rgba(255, 30, 90, 0.28))
        drop-shadow(-1px 0 0 rgba(0, 255, 255, 0.24));
      animation: crtFlicker 2.6s steps(60) infinite, crtJitter 6s ease-in-out infinite;
      box-shadow: var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.05);
    }
    html[data-mode="ddd"] .crt::before {
      content: "";
      position: absolute;
      inset: -1px;
      pointer-events: none;
      border-radius: inherit;
      mix-blend-mode: overlay;
      opacity: 0.85;
      background: repeating-linear-gradient(
        0deg,
        rgba(255,255,255,0.06) 0px,
        rgba(255,255,255,0.06) 2px,
        rgba(0,0,0,0.10) 2px,
        rgba(0,0,0,0.10) 4px
      );
      animation: scanShift 0.8s linear infinite;
    }
    html[data-mode="ddd"] .crt::after {
      content: "";
      position: absolute;
      inset: -1px;
      pointer-events: none;
      border-radius: inherit;
      opacity: 0.8;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.06) 0%, rgba(0,0,0,0.28) 80%);
    }
    html[data-mode="ddd"] .crt,
    html[data-mode="ddd"] .crt * {
      text-shadow:
        3px 0   0 rgba(255, 30, 90, 0.28),
        -3px 0  0 rgba(0, 255, 255, 0.24),
        0 0 0.8px rgba(255,240,200,0.35),
        0 0 6px   rgba(255,200,100,0.12),
        0 0 12px  rgba(255,180,80,0.06);
    }
    html[data-mode="ddd"] .crt textarea,
    html[data-mode="ddd"] .crt button,
    html[data-mode="ddd"] .crt input { background-clip: padding-box; }
    html[data-mode="ddd"] .crt textarea,
    html[data-mode="ddd"] .crt button,
    html[data-mode="ddd"] .crt input {
      box-shadow:
        inset 0 0 0 1px rgba(255, 30, 90, 0.10),
        inset 0 0 0 2px rgba(0, 255, 255, 0.06);
    }
  </style>
</head>
<body>
  <canvas id="gl" aria-hidden="true"></canvas>
  <div id="app">
    <div class="panel crt">
      <div class="content">
        <div class="row">
          <h1>ðŸ“» Werbespot Generator</h1>
          <span class="tag" id="modeTag">Regular Mode</span>
        </div>

        <!-- NEW: Radiobuttons fÃ¼r Regular / MAKER / DDD -->
        <fieldset class="mode-select" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; border:none; padding:0; margin:0;">
          <legend class="visually-hidden">Darstellungsmodus</legend>
          <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="radio" name="uimode" value="regular" checked />
            <span>Regular</span>
          </label>
          <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="radio" name="uimode" value="maker" />
            <span>MAKER</span>
          </label>
          <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="radio" name="uimode" value="ddd" />
            <span>DDD</span>
          </label>
        </fieldset>

        <label for="prompt" class="visually-hidden">Werbe-Thema</label>
        <textarea id="prompt" placeholder="WofÃ¼r soll der Spot werben? Produktname, Beschreibung und/oder Firma eingeben. Alles was fehlt, wird erfunden!"></textarea>

        <div class="actions">
          <button id="submit" class="primary">Absenden</button>
          <button id="reset" class="secondary hidden" title="Seite neu laden">Fertig â€“ zurÃ¼cksetzen</button>
        </div>

        <div id="status" role="status" aria-live="polite"></div>
        <div id="loader" class="loader hidden">
          <span class="ring" aria-hidden="true"></span>
          <span class="text">Erzeuge & mische Audioâ€¦</span>
        </div>
        <div id="result"></div>

        <div class="footer">
          <span>Â© Makey McMakeface</span>
          <span><a href="#" id="cfgLink">Konfiguration</a></span>
        </div>
      </div>
    </div>
  </div>

  <dialog id="cfgModal">
    <form method="dialog" style="min-width: min(520px, 92vw); padding: 16px 20px; border: 1px solid var(--border); border-radius: 12px; background: var(--glass); color: var(--fg);">
      <h3 style="margin: 0 0 10px;">Backend-Konfiguration</h3>
      <p style="margin: 0 0 8px; font-size: 14px; color: var(--muted);">Passe die Ziel-URL fÃ¼r deinen n8n-Webhook an.</p>
      <label style="display:block; font-size: 12px; opacity: .8;">n8n Endpoint URL</label>
      <input id="endpoint" type="text" style="width:100%; padding:10px 12px; border-radius:10px; border: 1px solid var(--border); background: rgba(255,255,255,.85); color:#0b1020;" />
      <!-- NEW: Spots Base Path -->
      <label style="display:block; font-size: 12px; opacity: .8; margin-top:10px;">Spots Base-Path (Ã¶ffentlich)</label>
      <input id="spotsBase" type="text" placeholder="/spots/" style="width:100%; padding:10px 12px; border-radius:10px; border: 1px solid var(--border); background: rgba(255,255,255,.85); color:#0b1020;" />

      <!-- NEW: Webhook Basic Auth -->
      <label style="display:block; font-size: 12px; opacity: .8; margin-top:10px;">Webhook Benutzername</label>
      <input id="whUser" type="text" placeholder="z.B. cg_web" style="width:100%; padding:10px 12px; border-radius:10px; border: 1px solid var(--border); background: rgba(255,255,255,.85); color:#0b1020;" />

      <label style="display:block; font-size: 12px; opacity: .8; margin-top:10px;">Webhook Passwort (nur aktuelle Sitzung)</label>
      <input id="whPass" type="password" placeholder="â€¢ â€¢ â€¢ â€¢ â€¢" style="width:100%; padding:10px 12px; border-radius:10px; border: 1px solid var(--border); background: rgba(255,255,255,.85); color:#0b1020;" />

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top: 12px;">
        <button value="cancel" style="padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; cursor:pointer;">Abbrechen</button>
        <button id="saveCfg" value="default" style="padding:8px 12px; border-radius:10px; border: none; background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:white; cursor:pointer;">Speichern</button>
      </div>
    </form>
  </dialog>

  <script>
    /* Minimal QR generator (Kazuhiko Arase, MIT) â€“ inlined tiny subset */
    // qrcode.js (minified) â€“ supports createSvgTag used below
    (function(){function p(a){this.mode=c.MODE_8BIT_BYTE;this.data=a;this.parsedData=[];for(var b=0,d=this.data.length;b<d;b++){var e=[],f=this.data.charCodeAt(b);256<f?e[0]=48224|f>>10,e[1]=56320|f&1023:(e[0]=f,128<=f&&(e[0]=194,f-=128),e[0]=f);this.parsedData.push(e)}this.parsedData=Array.prototype.concat.apply([],this.parsedData)}function q(a,b){this.typeNumber=a;this.errorCorrectLevel=b;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[]}function r(a,b){this.totalCount=a;this.dataCount=b}var c={PAD0:236,PAD1:17,MODE_8BIT_BYTE:4};p.prototype.getLength=function(){return this.parsedData.length};p.prototype.write=function(a){for(var b=0;b<this.parsedData.length;b++)a.put(this.parsedData[b],8)};q.prototype={addData:function(a){this.dataList.push(new p(a));this.dataCache=null},isDark:function(a,b){if(0>a||this.moduleCount<=a||0>b||this.moduleCount<=b)throw Error(a+","+b);return this.modules[a][b]},getModuleCount:function(){return this.moduleCount},make:function(){if(1>this.typeNumber)for(var a=1;40>a;a++){for(var b=r.getRSBlocks(a,this.errorCorrectLevel),d=0,e=0;e<b.length;e++)d+=b[e].dataCount;if(d>=this.getDataLength())break}this.typeNumber=a;this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(a,b){this.moduleCount=4*this.typeNumber+17;this.modules=Array(this.moduleCount);for(var d=0;d<this.moduleCount;d++){this.modules[d]=Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++)this.modules[d][e]=null}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.mapData(this.createData(this.typeNumber,this.errorCorrectLevel),b)},setupPositionProbePattern:function(a,b){for(var d=-1;7>=d;d++)if(!(0>a+d||this.moduleCount<=a+d))for(var e=-1;7>=e;e++)0>b+e||this.moduleCount<=b+e||(this.modules[a+d][b+e]=0<=d&&6>=d&&(0==e||6==e)||0<=e&&6>=e&&(0==d||6==d)||2<=d&&4>=d&&2<=e&&4>=e)},getBestMaskPattern:function(){for(var a=0,b=0,d=0;8>d;d++){this.makeImpl(!0,d);var e=t.getLostPoint(this);if(0==d||a>e)a=e,b=d}return b},createData:function(a,b){for(var d=r.getRSBlocks(a,b),e=new u,f=0;f<this.dataList.length;f++){var g=this.dataList[f];e.put(4,4);e.put(g.getLength(),8);g.write(e)}for(f=e.getLengthInBits(),g=0;g<d.length;g++)f+=16*d[g].dataCount;for(f=Math.min(f,8*(function(h){h=4*h+17;return h*h})(a));e.getLengthInBits()>f;)e=e;for(e.put(0,4);0!=e.getLengthInBits()%8;)e.putBit(!1);for(;!(e.getLengthInBits()>=f);)e.put(c.PAD0,8),e.getLengthInBits()>=f||e.put(c.PAD1,8);return v.createBytes(e,d)},mapData:function(a,b){for(var d=-1,e=this.moduleCount-1,f=7,g=0,h=this.moduleCount-1;0<=h;h-=2)for(6==h&&h--;;){for(var k=0;2>k;k++)if(null==this.modules[e][h-k]){var l=!1;g<a.length&&(l=1==(a[g]>>>f&1));t.getMask(b,e,h-k)&&(l=!l);this.modules[e][h-k]=l}f--;if(0>f){g++;f=7}e+=d;if(0>e||this.moduleCount<=e){e-=d;d=-d;break}}},setupTimingPattern:function(){for(var a=8;a<this.moduleCount-8;a++)null==this.modules[a][6]&&(this.modules[a][6]=0==a%2),null==this.modules[6][a]&&(this.modules[6][a]=0==a%2)},setupPositionAdjustPattern:function(){for(var a=t.getPatternPosition(this.typeNumber),b=0;b<a.length;b++)for(var d=0;d<a.length;d++){var e=a[b],f=a[d];if(null==this.modules[e][f])for(var g=-2;2>=g;g++)for(var h=-2;2>=h;h++)this.modules[e+g][f+h]=-2==g||2==g||-2==h||2==h||0==g&&0==h}}};var t={getPatternPosition:function(a){return 1==a?[]:2==a?[6,18]:3==a?[6,22]:4==a?[6,26]:5==a?[6,30]:6==a?[6,34]:7==a?[6,22,38]:8==a?[6,24,42]:9==a?[6,26,46]:10==a?[6,28,50]:11==a?[6,30,54]:12==a?[6,32,58]:13==a?[6,34,62]:14==a?[6,26,46,66]:15==a?[6,26,48,70]:16==a?[6,26,50,74]:17==a?[6,30,54,78]:18==a?[6,30,56,82]:19==a?[6,30,58,86]:20==a?[6,34,62,90]:21==a?[6,28,50,72,94]:22==a?[6,26,50,74,98]:23==a?[6,30,54,78,102]:24==a?[6,28,54,80,106]:25==a?[6,32,58,84,110]:26==a?[6,30,58,86,114]:27==a?[6,34,62,90,118]:28==a?[6,26,50,74,98,122]:29==a?[6,30,54,78,102,126]:30==a?[6,26,50,74,98,122,146]:31==a?[6,30,54,78,102,126,150]:32==a?[6,34,62,90,118,146]:33==a?[6,30,54,78,102,126,150]:34==a?[6,24,50,76,102,128]:35==a?[6,28,54,80,106,132]:36==a?[6,32,58,84,110,136]:37==a?[6,28,52,76,100,124,148]:[6,32,56,80,104,128,152]},getMask:function(a,b,d){switch(a){case 0:return 0==(b+d)%2;case 1:return 0==b%2;case 2:return 0==d%3;case 3:return 0==(b+d)%3;case 4:return 0==(Math.floor(b/2)+Math.floor(d/3))%2;case 5:return 0==b*d%2+ b*d%3;case 6:return 0==(b*d%2+b*d%3)%2;case 7:return 0==(b*d%3+(b+d)%2)%2}throw"bad maskPattern:"+a},getLostPoint:function(a){for(var b=a.getModuleCount(),d=0,e=0;e<b;e++)for(var f=0;f<b;f++){for(var g=0,h=a.isDark(e,f),k=-1;1>=k;k++)if(!(0>e+k||b<=e+k))for(var l=-1;1>=l;l++)0>f+l||b<=f+l||0==k&&0==l||h!=a.isDark(e+k,f+l)||g++;4<g&&(d+=3+g-5)}for(e=0;e<b-1;e++)for(f=0;f<b-1;f++){var m=0;a.isDark(e,f)&&m++;a.isDark(e+1,f)&&m++;a.isDark(e,f+1)&&m++;a.isDark(e+1,f+1)&&m++;0==m||4==m&&(d+=3)}for(e=0;e<b;e++)for(f=0;f<b-6;f++)a.isDark(e,f)&&!a.isDark(e,f+1)&&a.isDark(e,f+2)&&a.isDark(e,f+3)&&a.isDark(e,f+4)&&!a.isDark(e,f+5)&&a.isDark(e,f+6)&&(d+=40);for(f=0;f<b;f++)for(e=0;e<b-6;e++)a.isDark(e,f)&&!a.isDark(e+1,f)&&a.isDark(e+2,f)&&a.isDark(e+3,f)&&a.isDark(e+4,f)&&!a.isDark(e+5,f)&&a.isDark(e+6,f)&&(d+=40);for(f=0,e=0;e<b;e++)for(g=0;g<b;g++)a.isDark(e,g)&&f++;a=Math.abs(100*f/b/b-50)/5;d+=10*a} };var v={createBytes:function(a,b){for(var d=0,e=0,f=0,g=[],h=0;h<b.length;h++)d+=b[h].dataCount,e+=b[h].totalCount-b[h].dataCount;for(var k=0;k<d;k++)g.push(0);for(h=0;h<this.getMaxLength(b);h++)for(k=0;k<b.length;k++){var l=b[k].dataCount;if(h<l){var m=h*b[k].dataCount/(l|0);g[m]|=a.buffer[m]&255} }return g},getMaxLength:function(a){for(var b=0,d=0;d<a.length;d++)b=Math.max(b,a[d].dataCount);return b}};u=function(){this.buffer=[];this.length=0};u.prototype={getLengthInBits:function(){return this.length},put:function(a,b){for(var d=0;d<b;d++)this.putBit((a>>b-d-1&1)==1)},putBit:function(a){this.buffer.push(a?1:0);this.length++}};r.RS_BLOCK_TABLE=[[1,26,19],[1,44,34],[1,70,55],[1,100,80]];r.getRSBlocks=function(a,b){var d=r.RS_BLOCK_TABLE[Math.max(0,Math.min(a-1,3))];return[d.map?new r(d[1],d[2]):new r(d[1],d[2])]};
    window.qrcode=function(typeNumber,ecLevel){return new q(typeNumber||0,ecLevel||1)};
    window.renderQR = function(container, text, size){
      // leeren
      container.innerHTML = '';
      var targetSize = Math.max(80, size || 140);

      // 1) Canvas-Variante (lokal)
      try {
        var qr = qrcode(0,1); // auto Version
        qr.addData(String(text || ''));
        qr.make();

        var count = qr.getModuleCount();
        var cs = Math.max(3, Math.floor(targetSize / count));
        var pad = 2;
        var w = count * cs + pad*2;

        var cvs = document.createElement('canvas');
        cvs.width = w; cvs.height = w; cvs.className = 'qrcanvas';
        var ctx = cvs.getContext('2d');

        // WeiÃŸer Hintergrund, damit CRT/Filter ihn nicht verschlucken
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,w,w);

        ctx.fillStyle = '#000000';
        for (var r=0; r<count; r++){
          for (var c=0; c<count; c++){
            if (qr.isDark(r,c)) ctx.fillRect(pad + c*cs, pad + r*cs, cs, cs);
          }
        }

        container.appendChild(cvs);

        // Sicherheitsnetz: wenn nichts drin/sichtbar, fallback
        setTimeout(function(){
          if (!container.firstChild || container.firstChild.tagName !== 'CANVAS') {
            fallbackImg();
          }
        }, 0);
        return;
      } catch(e) {
        // gehe zum Fallback
      }

      // 2) Fallback: externer QR als IMG
      function fallbackImg(){
        var img = document.createElement('img');
        img.alt = 'QR';
        img.width = targetSize; img.height = targetSize;
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        var enc = encodeURIComponent(String(text || ''));
        img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=' + targetSize + 'x' + targetSize + '&data=' + enc;
        container.innerHTML = '';
        container.appendChild(img);

      }
      fallbackImg();
    };
  </script>
  <script>
    // --- Config ---
    const DEFAULT_ENDPOINT = 'https://n8n.achterberg.rocks/webhook/radio-spot';
    const SPOTS_BASE = (localStorage.getItem('rs_spots_base') || '/spots/');

    function getAuth(){
      return {
        u: localStorage.getItem('rs_wh_user') || '',
        p: sessionStorage.getItem('rs_wh_pass') || ''
      };
    }
    function buildDefaultAudioUrl(jobId){
      const base = getSpotsBase();
      const id = cleanJobId(jobId);
      const origin = window.location.origin;
      return `${origin}${base}${id}/output_${id}.mp3`;
    }
    async function waitForUrl(url, { tries = 120, delayMs = 1000 } = {}){
      for (let i=0; i<tries; i++){
        try { const res = await fetch(url, { method: 'HEAD', cache: 'no-store' }); if (res.ok) return true; } catch {}
        if (i % 5 === 0) { statusEl.textContent = 'Warte auf fertige Dateiâ€¦ (' + (i+1) + '/' + tries + ')'; }
        await new Promise(r => setTimeout(r, delayMs));
      }
      return false;
    }

    const $ = (sel) => document.querySelector(sel);
    const app = {
      endpoint: localStorage.getItem('rs_endpoint') || DEFAULT_ENDPOINT,
      mode: 'regular'
    };

    const modeTag = $('#modeTag');
    const submitBtn = $('#submit');
    const resetBtn = $('#reset');
    const promptEl = $('#prompt');
    const statusEl = $('#status');
    const resultEl = $('#result');

    const loaderEl = document.getElementById('loader');
    const loaderTextEl = loaderEl ? loaderEl.querySelector('.text') : null;
    function showLoader(msg){ if(loaderEl){ if(loaderTextEl && msg) loaderTextEl.textContent = msg; loaderEl.classList.remove('hidden'); } }
    function hideLoader(){ if(loaderEl){ loaderEl.classList.add('hidden'); } }
    function isValidJobId(v){ return typeof v==='string' && /^[A-Za-z0-9-]{6,}$/.test(v) && v.indexOf('{{')===-1; }
    function b64utf8(s){ return btoa(unescape(encodeURIComponent(s))); }
    function cleanJobId(v){
      if(v==null) return '';
      v = String(v).trim();
      v = v.replace(/^=+/, '').replace(/=+/g, '');
      if (v.includes('{{') || v.includes('}}')) return '';
      v = v.replace(/[^A-Za-z0-9-]/g, '');
      return v;
    }
    function getSpotsBase(){
      let v = localStorage.getItem('rs_spots_base') || '/spots/';
      v = String(v).trim();
      if (!v.startsWith('/')) v = '/' + v;
      v = v.replace(/=+/g, '').replace(/\s+/g, '');
      if (v.includes('{{') || v.includes('}}')) v = '/spots/';
      if (!v.endsWith('/')) v += '/';
      return v;
    }
    function sanitizeAudioUrl(u, jobId){
      if(typeof u !== 'string') return '';
      const s = u.trim();
      if (!s || s.includes('{{') || s.includes('}}') || s.includes('/=' ) || s.includes('output_=')) return '';
      if (jobId){
        const j = jobId;
        return s.replace('/='+j+'/', '/'+j+'/').replace('output_='+j, 'output_'+j);
      }
      return s;
    }

    // ====== BACKGROUND SHADER ENGINE ======
    const canvas = document.getElementById('gl');
    let gl, program, uTime, uRes, startTime, buffer, animationId;

    const VERT = `attribute vec2 a_pos; void main(){ gl_Position = vec4(a_pos,0.0,1.0);} `;

    /* DDD shader (unverÃ¤ndert) */
    const DDD_FRAG = `#ifdef GL_ES
precision mediump float;
#endif
uniform vec2  u_res;
uniform float u_time;
float hash(vec2 p){ return fract(sin(dot(p, vec2(127.1,311.7))) * 43758.5453); }
float noise(vec2 p){
  vec2 i=floor(p), f=fract(p);
  float a=hash(i), b=hash(i+vec2(1.0,0.0)), c=hash(i+vec2(0.0,1.0)), d=hash(i+vec2(1.0,1.0));
  vec2 u=f*f*(3.0-2.0*f);
  return mix(a,b,u.x) + (c-a)*u.y*(1.0-u.x) + (d-b)*u.x*u.y;
}
float onOff(float a, float b, float c){ return step(c, sin(u_time + a*cos(u_time*b))); }
float ramp(float y, float start, float end){
  float inside = step(start,y) - step(end,y);
  float fact = (y-start)/(end-start)*inside;
  return (1.0 - fact) * inside;
}
vec2 iso(vec2 frag){
  vec2 uv = frag / u_res;
  uv = uv*2.0 - 1.0;
  uv.x *= u_res.x / u_res.y;
  return uv;
}
float stripes(vec2 uv){
  float noi = noise(uv*vec2(0.5,1.0) + vec2(1.0,3.0));
  float s = ramp(mod(uv.y*4.0 + u_time/2.0 + sin(u_time + sin(u_time*0.63)), 1.0), 0.5, 0.6) * noi;
  return s;
}
vec2 screenDistort(vec2 uv){
  uv -= vec2(0.5);
  uv = uv*1.2*(1.0/1.2 + 2.0*uv.x*uv.x*uv.y*uv.y);
  uv += vec2(0.5);
  return uv;
}
vec3 getVideo(vec2 uv){
  vec2 look = uv;
  float window = 1.0 / (1.0 + 20.0 * pow(look.y - mod(u_time/4.0, 1.0), 2.0));
  look.x += sin(look.y*10.0 + u_time)/50.0 * onOff(4.0,4.0,0.3) * (1.0 + cos(u_time*80.0)) * window;
  float vShift = 0.4 * onOff(2.0,3.0,0.9) *
                 (sin(u_time)*sin(u_time*20.0) + (0.5 + 0.1*sin(u_time*200.0)*cos(u_time)));
  look.y = fract(look.y + vShift);
  float bands = 0.5 + 0.5*sin(look.y*80.0 + u_time*6.0);
  float xmod  = 0.5 + 0.5*sin(look.x*30.0 + u_time*3.0);
  vec3 video  = vec3(mix(0.25, 0.9, bands * xmod));
  video = mix(video, vec3(0.86,0.73,0.53), 0.65);
  return video;
}
void main(){
  vec2 frag = gl_FragCoord.xy;
  vec2 uv = frag / u_res;
  uv = screenDistort(uv);
  vec3 video = getVideo(uv);
  float vigAmt = 3.0 + 0.3*sin(u_time + 5.0*cos(u_time*5.0));
  float dx = uv.x - 0.5, dy = uv.y - 0.5;
  float vignette = (1.0 - vigAmt*dy*dy) * (1.0 - vigAmt*dx*dx);
  vignette = clamp(vignette, 0.0, 1.0);
  video += stripes(uv);
  video += noise(iso(frag)*2.0)/2.0;
  video *= vignette;
  video *= (12.0 + mod(uv.y*30.0 + u_time, 1.0)) / 13.0;
  gl_FragColor = vec4(video, 1.0);
}`;

    /* REGULAR shader (Clouds â€“ unverÃ¤ndert zu deiner letzten Version) */
    const REGULAR_FRAG = `#ifdef GL_ES
precision mediump float;
#endif
uniform vec2  u_res;
uniform float u_time;
#define iResolution u_res
#define iTime       u_time
const float cloudscale = 1.1;
const float speed = 0.03;
const float clouddark = 0.5;
const float cloudlight = 0.3;
const float cloudcover = 0.2;
const float cloudalpha = 8.0;
const float skytint = 0.5;
const vec3 skycolour1 = vec3(0.2, 0.4, 0.6);
const vec3 skycolour2 = vec3(0.4, 0.7, 1.0);
const mat2 m = mat2( 1.6,  1.2, -1.2,  1.6 );
vec2 hash( vec2 p ) {
  p = vec2(dot(p,vec2(127.1,311.7)), dot(p,vec2(269.5,183.3)));
  return -1.0 + 2.0*fract(sin(p)*43758.5453123);
}
float noise( in vec2 p ) {
  const float K1 = 0.366025404;
  const float K2 = 0.211324865;
  vec2 i = floor(p + (p.x+p.y)*K1);
  vec2 a = p - i + (i.x+i.y)*K2;
  vec2 o = (a.x>a.y) ? vec2(1.0,0.0) : vec2(0.0,1.0);
  vec2 b = a - o + K2;
  vec2 c = a - 1.0 + 2.0*K2;
  vec3 h = max(0.5-vec3(dot(a,a), dot(b,b), dot(c,c) ), 0.0 );
  vec3 n = h*h*h*h*vec3( dot(a,hash(i+0.0)), dot(b,hash(i+o)), dot(c,hash(i+1.0)));
  return dot(n, vec3(70.0));
}
float fbm(vec2 n) {
  float total = 0.0, amplitude = 0.1;
  for (int i = 0; i < 7; i++) {
    total += noise(n) * amplitude;
    n = m * n;
    amplitude *= 0.4;
  }
  return total;
}
void mainImage( out vec4 fragColor, in vec2 fragCoord ) {
  vec2 p = fragCoord.xy / iResolution.xy;
  vec2 uv = p*vec2(iResolution.x/iResolution.y,1.0);
  float time = iTime * speed;
  float q = fbm(uv * cloudscale * 0.5);
  float r = 0.0;
  uv *= cloudscale;
  uv -= q - time;
  float weight = 0.8;
  for (int i=0; i<8; i++){
    r += abs(weight*noise( uv ));
    uv = m*uv + time;
    weight *= 0.7;
  }
  float f = 0.0;
  uv = p*vec2(iResolution.x/iResolution.y,1.0);
  uv *= cloudscale;
  uv -= q - time;
  weight = 0.7;
  for (int i=0; i<8; i++){
    f += weight*noise( uv );
    uv = m*uv + time;
    weight *= 0.6;
  }
  f *= r + f;
  float c = 0.0;
  time = iTime * speed * 2.0;
  uv = p*vec2(iResolution.x/iResolution.y,1.0);
  uv *= cloudscale*2.0;
  uv -= q - time;
  weight = 0.4;
  for (int i=0; i<7; i++){
    c += weight*noise( uv );
    uv = m*uv + time;
    weight *= 0.6;
  }
  float c1 = 0.0;
  time = iTime * speed * 3.0;
  uv = p*vec2(iResolution.x/iResolution.y,1.0);
  uv *= cloudscale*3.0;
  uv -= q - time;
  weight = 0.4;
  for (int i=0; i<7; i++){
    c1 += abs(weight*noise( uv ));
    uv = m*uv + time;
    weight *= 0.6;
  }
  c += c1;
  vec3 skycolour = mix(skycolour2, skycolour1, p.y);
  vec3 cloudcolour = vec3(1.1, 1.1, 0.9) * clamp((clouddark + cloudlight*c), 0.0, 1.0);
  f = cloudcover + cloudalpha*f*r;
  vec3 result = mix(skycolour, clamp(skytint * skycolour + cloudcolour, 0.0, 1.0), clamp(f + c, 0.0, 1.0));
  fragColor = vec4( result, 1.0 );
}
void main(){ vec4 col; mainImage(col, gl_FragCoord.xy); gl_FragColor = col; }`;

    /* NEW: MAKER shader â€“ Fewer, longer traces with strong horizontal/vertical stripes and rare diagonals */
    const MAKER_FRAG = `#ifdef GL_ES
precision mediump float;
#endif
uniform vec2  u_res;
uniform float u_time;
#define iResolution u_res
#define iTime       u_time
void mainImage( out vec4 O,  vec2 U )
{
    vec2 R = iResolution.xy;
    float C = 1. - U.y / R.y;
    U = 5. * ( U + U - R ) / R.y;   // normalized coordinates
    U.y = 1. - U.y * 2.;            // swap vertical
    U /= 1. + U.y / 10.;            // perspective
    U.y -= iTime;
    U = abs(fract(U) - .50);        // distance to axis
    U = .1 / sqrt(U);               // turn to blurred line
    O = (U.x*C + U.y*C*2.) * vec4(.3,.3,1.,1.) * C + vec4(.4,0.1,.2,1.) * C;
}
void main(){ vec4 col; mainImage(col, gl_FragCoord.xy); gl_FragColor = col; }`;

    /* Shader-Registry: jetzt mit MAKER */
    const shaders = { regular: {frag: REGULAR_FRAG}, maker: {frag: MAKER_FRAG}, ddd: {frag: DDD_FRAG} };

    function createShader(type, source){
      const s = gl.createShader(type); gl.shaderSource(s, source); gl.compileShader(s);
      if(!gl.getShaderParameter(s, gl.COMPILE_STATUS)){ console.error(gl.getShaderInfoLog(s)); throw new Error('Shader compile error'); }
      return s;
    }
    function createProgram(vsSource, fsSource){
      const vs = createShader(gl.VERTEX_SHADER, vsSource);
      const fs = createShader(gl.FRAGMENT_SHADER, fsSource);
      const prog = gl.createProgram(); gl.attachShader(prog, vs); gl.attachShader(prog, fs); gl.linkProgram(prog);
      if(!gl.getProgramParameter(prog, gl.LINK_STATUS)){ console.error(gl.getProgramInfoLog(prog)); throw new Error('Program link error'); }
      return prog;
    }

    function initGL(){
      if(!gl){
        gl = canvas.getContext('webgl', {antialias:false, preserveDrawingBuffer:false});
        if(!gl){ fallback2D(); return; }
        buffer = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 3,-1, -1,3]), gl.STATIC_DRAW);
      }
      if(program){ gl.deleteProgram(program); program = null; }
      const fragSrc = (app.mode === 'ddd') ? shaders.ddd.frag : (app.mode === 'maker' ? shaders.maker.frag : shaders.regular.frag);
      program = createProgram(VERT, fragSrc);
      gl.useProgram(program);
      const loc = gl.getAttribLocation(program, 'a_pos'); gl.enableVertexAttribArray(loc);
      gl.bindBuffer(gl.ARRAY_BUFFER, buffer); gl.vertexAttribPointer(loc, 2, gl.FLOAT, false, 0, 0);
      uTime = gl.getUniformLocation(program, 'u_time'); uRes = gl.getUniformLocation(program, 'u_res');
      startTime = performance.now(); onResize(); if(animationId) cancelAnimationFrame(animationId); tick();
    }
    function onResize(){
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      const w = Math.floor(innerWidth * dpr); const h = Math.floor(innerHeight * dpr);
      if(canvas.width !== w || canvas.height !== h){ canvas.width = w; canvas.height = h; canvas.style.width = '100%'; canvas.style.height = '100%'; }
      if(gl && uRes){ gl.viewport(0,0,w,h); gl.uniform2f(uRes, w, h); }
    }
    function tick(){ if(!gl || !program) return; const t = (performance.now() - startTime)/1000; if(uTime) gl.uniform1f(uTime, t); gl.drawArrays(gl.TRIANGLES, 0, 3); animationId = requestAnimationFrame(tick); }
    function fallback2D(){
      const ctx = canvas.getContext('2d'); let t0 = performance.now();
      function loop(){ const t = (performance.now()-t0)/1000; const w = canvas.width = innerWidth; const h = canvas.height = innerHeight; const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0, '#0ea5e9'); g.addColorStop(1, '#22d3ee'); ctx.fillStyle = g; ctx.fillRect(0,0,w,h); requestAnimationFrame(loop);} loop();
    }
    window.addEventListener('resize', onResize);

    // ====== APP LOGIC ======
    function applyMode(){
      document.documentElement.setAttribute('data-mode', app.mode);
      modeTag.textContent = app.mode === 'ddd' ? 'DDD Mode' : (app.mode === 'maker' ? 'MAKER Mode' : 'Regular Mode');
      // Update page title per mode
      const titleEl = document.querySelector('h1');
      if (titleEl) {
        if (app.mode === 'ddd') {
          titleEl.textContent = 'DOOMSDAY DISPATCH Werbespotgenerator';
        } else {
          titleEl.textContent = 'ðŸ“» Werbespot Generator';
        }
      }
      try { localStorage.setItem('rs_mode', app.mode); } catch {}
      initGL();
    }
    // NEW: radios statt checkbox
    const modeRadios = Array.from(document.querySelectorAll('input[name="uimode"]'));
    function setMode(m){ app.mode = m; try { localStorage.setItem('rs_mode', m); } catch{} applyMode(); }
    modeRadios.forEach(r => r.addEventListener('change', (e)=>{ if(e.target.checked) setMode(e.target.value); }));

    async function submit(){
      const prompt = (promptEl.value || '').trim(); if(!prompt){ promptEl.focus(); return; }
      const mode = app.mode; statusEl.textContent = 'Sende an n8nâ€¦'; submitBtn.disabled = true;
      showLoader('Erzeuge & mische Audioâ€¦');
      try {
        const headers = { 'Content-Type': 'application/json' };
        const {u,p} = getAuth();
        if(u && p){ headers['Authorization'] = 'Basic ' + b64utf8(`${u}:${p}`); }

        const res = await fetch(app.endpoint, { method: 'POST', headers, body: JSON.stringify({ prompt, mode }) });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        let data = {}; if (res.status !== 204) { try { data = await res.json(); } catch(e) { data = {}; } }
        const jobIdHeader = (res.headers.get('x-job-id') || res.headers.get('jobid') || res.headers.get('x-request-id') || '').trim();
        resultEl.innerHTML = '';
        const rawId = data && data.jobId ? String(data.jobId) : jobIdHeader;
        const jobId = cleanJobId(rawId);
        if (!isValidJobId(jobId)) { hideLoader(); statusEl.textContent = 'Keine gÃ¼ltige Job-ID erhalten.'; return; }
        let url = buildDefaultAudioUrl(jobId).replace('/=', '/').replace('output_=', 'output_');
        if (!url) { hideLoader(); statusEl.textContent = data.message || 'Keine URL/Job-ID erhalten.'; return; }

        statusEl.textContent = 'Warte auf fertige Dateiâ€¦';
        const ok = await waitForUrl(url, { tries: 180, delayMs: 1000 });
        hideLoader();

        if (!ok) {
          statusEl.textContent = 'Datei nicht gefunden (Timeout).';
          const pEl = document.createElement('p'); pEl.textContent = url; resultEl.appendChild(pEl);
          const retryBtn = document.createElement('button');
          retryBtn.textContent = 'Erneut prÃ¼fen';
          retryBtn.className = 'primary';
          retryBtn.addEventListener('click', async () => {
            retryBtn.disabled = true;
            statusEl.textContent = 'PrÃ¼fe erneutâ€¦'; showLoader('PrÃ¼fe erneutâ€¦');
            const ok2 = await waitForUrl(url, { tries: 45, delayMs: 1000 });
            hideLoader();
            if (ok2) {
              statusEl.textContent = 'Spot bereit.'; resultEl.innerHTML = '';
              const a = document.createElement('audio'); a.controls = true; a.src = url + '?t=' + Date.now(); resultEl.appendChild(a);
              const dl = document.createElement('a'); dl.href = url; dl.download = `output_${jobId}.mp3`; dl.textContent = 'Download MP3'; dl.className = 'download-link'; resultEl.appendChild(dl);
              // QR code box
              const qrWrap = document.createElement('div');
              qrWrap.className = 'qrbox';
              const qrLabel = document.createElement('span');
              qrLabel.className = 'label';
              qrLabel.textContent = 'QR zum Download';
              const qrHolder = document.createElement('div');
              qrWrap.appendChild(qrHolder);
              qrWrap.appendChild(qrLabel);
              resultEl.appendChild(qrWrap);
              // Fallback IMG immediately, then try to upgrade to canvas if available
              const qrImg = document.createElement('img');
              qrImg.alt = 'QR';
              qrImg.width = 140; qrImg.height = 140;
              qrImg.decoding = 'async';
              qrImg.referrerPolicy = 'no-referrer';
              qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=' + encodeURIComponent(url);
              qrHolder.appendChild(qrImg);
              if (window.renderQR) {
                try { window.renderQR(qrHolder, url, 140); } catch(e) { /* leave IMG */ }
              }
              try { await a.play(); } catch {}
              resetBtn.classList.remove('hidden');
            } else { statusEl.textContent = 'Noch nicht verfÃ¼gbar.'; retryBtn.disabled = false; }
          });
          resultEl.appendChild(retryBtn);
          return;
        }

        statusEl.textContent = data.message || 'Spot bereit.';
        const a = document.createElement('audio'); a.controls = true; a.src = url + '?t=' + Date.now(); resultEl.appendChild(a);
        const dl = document.createElement('a'); dl.href = url; dl.download = `output_${jobId}.mp3`; dl.textContent = 'Download MP3'; dl.className = 'download-link'; resultEl.appendChild(dl);
        // QR code box
        const qrWrap = document.createElement('div');
        qrWrap.className = 'qrbox';
        const qrLabel = document.createElement('span');
        qrLabel.className = 'label';
        qrLabel.textContent = 'QR zum Download';
        const qrHolder = document.createElement('div');
        qrWrap.appendChild(qrHolder);
        qrWrap.appendChild(qrLabel);
        resultEl.appendChild(qrWrap);
        // Fallback IMG immediately, then try to upgrade to canvas if available
        const qrImg = document.createElement('img');
        qrImg.alt = 'QR';
        qrImg.width = 140; qrImg.height = 140;
        qrImg.decoding = 'async';
        qrImg.referrerPolicy = 'no-referrer';
        qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=' + encodeURIComponent(url);
        qrHolder.appendChild(qrImg);
        if (window.renderQR) {
          try { window.renderQR(qrHolder, url, 140); } catch(e) { /* leave IMG */ }
        }
        try { await a.play(); } catch {}
        resetBtn.classList.remove('hidden');
      } catch (err) {
        statusEl.textContent = 'Fehler: ' + (err && err.message ? err.message : err);
      } finally {
        hideLoader();
        submitBtn.disabled = false;
      }
    }
    submitBtn.addEventListener('click', submit);
    resetBtn.addEventListener('click', () => { window.location.reload(); });
    promptEl.addEventListener('keydown', (e) => { if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='enter'){ submit(); } });

    // Settings modal (unverÃ¤ndert)
    const cfgModal = document.getElementById('cfgModal');
    const cfgLink = document.getElementById('cfgLink');
    const endpointInput = document.getElementById('endpoint');
    const spotsBaseInput = document.getElementById('spotsBase');
    const whUserInput = document.getElementById('whUser');
    const whPassInput = document.getElementById('whPass');
    const saveCfg = document.getElementById('saveCfg');
    cfgLink.addEventListener('click', (e) => {
      e.preventDefault();
      endpointInput.value = app.endpoint;
      spotsBaseInput.value = SPOTS_BASE;
      const {u,p} = getAuth();
      whUserInput.value = u;
      whPassInput.value = p;
      cfgModal.showModal();
    });
    saveCfg.addEventListener('click', () => {
      app.endpoint = endpointInput.value.trim() || DEFAULT_ENDPOINT;
      localStorage.setItem('rs_endpoint', app.endpoint);
      let v = spotsBaseInput.value.trim() || '/spots/';
      if (!v.startsWith('/')) v = '/' + v;
      v = v.replace(/=+/g, '').replace(/\s+/g, '');
      if (!v.endsWith('/')) v += '/';
      localStorage.setItem('rs_spots_base', v);
      const u = (whUserInput.value || '').trim();
      const p = (whPassInput.value || '').trim();
      localStorage.setItem('rs_wh_user', u);
      if (p) sessionStorage.setItem('rs_wh_pass', p);
    });

    (function boot(){
      try {
        const saved = localStorage.getItem('rs_mode');
        if (saved === 'ddd' || saved === 'maker' || saved === 'regular') app.mode = saved;
      } catch {}
      const r = document.querySelector(`input[name="uimode"][value="${app.mode}"]`);
      if (r) r.checked = true;
      applyMode();
    })();
  </script>
</body>
</html>